{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OEM Business Intelligence Dashboard</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    <style>
        :root {
            --primary-color: #4e73df;
            --success-color: #1cc88a;
            --info-color: #36b9cc;
            --warning-color: #f6c23e;
            --danger-color: #e74a3b;
            --dark-color: #5a5c69;
            --light-bg: #f8f9fc;
        }

        body { background-color: var(--light-bg); font-family: 'Nunito', sans-serif; }
        .navbar { background: linear-gradient(135deg, var(--primary-color) 0%, #224abe 100%); box-shadow: 0 2px 4px rgba(0,0,0,.1); }
        .card { border: none; border-radius: 10px; box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15); margin-bottom: 1.5rem; }
        .card-header { background-color: #f8f9fc; border-bottom: 1px solid #e3e6f0; font-weight: 700; }
        .border-left-primary { border-left: 0.25rem solid var(--primary-color) !important; }
        .border-left-success { border-left: 0.25rem solid var(--success-color) !important; }
        .border-left-info { border-left: 0.25rem solid var(--info-color) !important; }
        .border-left-warning { border-left: 0.25rem solid var(--warning-color) !important; }
        .chart-area { height: 300px; position: relative; }
        .chart-pie { height: 250px; position: relative; }
        .table th, .table td { font-size: 0.85rem; vertical-align: middle; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-dark sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="{% url 'oem_reporting:reports_menu' %}">
                <i class="fas fa-chart-line me-2"></i>
                OEM BI Dashboard
            </a>
            <div class="d-flex align-items-center">
                <span class="text-white me-3">
                    <i class="fas fa-user-circle me-1"></i>
                    {{ request.user.username }}
                </span>
                <a href="{% url 'oem_reporting:reports_menu' %}" class="btn btn-outline-light btn-sm">
                    <i class="fas fa-arrow-left me-1"></i> Back to Reports
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid py-4">
        <!-- Development Mode Notice -->
        {% if using_local_data %}
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Development Mode:</strong> {{ db_message|default:"Using local store database. OEM sync database not accessible." }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}

        <!-- Dashboard Header with Filter -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-0 text-gray-800">Business Intelligence Dashboard</h1>
                <p class="text-muted">Analyze sales, inventory, and customer trends</p>
            </div>
            <div>
                <!-- Date Filter Form -->
                <form method="GET" id="filterForm" class="form-inline">
                    <div class="input-group">
                        <select name="filter" class="form-select form-select-sm" id="filterSelect" onchange="this.form.submit()">
                            <option value="today" {% if filter_type == 'today' %}selected{% endif %}>Today</option>
                            <option value="this_week" {% if filter_type == 'this_week' %}selected{% endif %}>This Week</option>
                            <option value="this_month" {% if filter_type == 'this_month' %}selected{% endif %}>This Month</option>
                            <option value="this_year" {% if filter_type == 'this_year' %}selected{% endif %}>This Year</option>
                            <option value="custom" {% if filter_type == 'custom' %}selected{% endif %}>Custom Range</option>
                        </select>
                        <!-- Custom Date Inputs -->
                        <div id="customDateInputs" class="ms-2" style="display: {% if filter_type == 'custom' %}flex{% else %}none{% endif %};">
                            <input type="date" name="start_date" class="form-control form-control-sm me-1"
                                   value="{{ request.GET.start_date|default:start_date|date:'Y-m-d' }}">
                            <input type="date" name="end_date" class="form-control form-control-sm me-1"
                                   value="{{ request.GET.end_date|default:end_date|date:'Y-m-d' }}">
                            <button class="btn btn-primary btn-sm" type="submit">
                                <i class="fas fa-filter"></i> Apply
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-primary shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Revenue (Period)</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">₦{{ total_revenue|floatformat:2 }}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-success shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Sales Orders</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_sales_count }}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-receipt fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-info shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Avg Order Value</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">₦{{ avg_order_value|floatformat:2 }}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-tags fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-warning shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Low Stock Items</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">{{ low_stock_count }}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <!-- Revenue Chart -->
            <div class="col-xl-8 col-lg-7">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Revenue Over Time</h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-area">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sales by Category -->
            <div class="col-xl-4 col-lg-5">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Sales by Category</h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-pie">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Analytics Row -->
        <div class="row mb-4">
            <!-- Top Selling Products -->
            <div class="col-lg-6">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Top Selling Products</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th>Rank</th>
                                        <th>Brand</th>
                                        <th>Category</th>
                                        <th>Units Sold</th>
                                        <th>Revenue</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for product in top_products %}
                                    <tr>
                                        <td><strong>#{{ forloop.counter }}</strong></td>
                                        <td>{{ product.brand }}</td>
                                        <td>{{ product.category }}</td>
                                        <td>{{ product.total_units_sold }}</td>
                                        <td>₦{{ product.total_revenue|floatformat:2 }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">No sales in this period</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Sales -->
            <div class="col-lg-6">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Recent Sales Activity</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered table-sm">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Brand</th>
                                        <th>Location</th>
                                        <th>Units</th>
                                        <th>Revenue</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for sale in recent_sales %}
                                    <tr>
                                        <td>{{ sale.summary_date|date:"M d" }}</td>
                                        <td>{{ sale.brand }}</td>
                                        <td>{{ sale.location }}</td>
                                        <td>{{ sale.total_units_sold }}</td>
                                        <td>₦{{ sale.total_revenue|floatformat:2 }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">No recent sales</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Metrics Row -->
        <div class="row mb-4">
            <!-- Location Performance -->
            <div class="col-lg-6">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Location Performance</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered table-sm">
                                <thead>
                                    <tr>
                                        <th>Location</th>
                                        <th>Total Units</th>
                                        <th>Total Revenue</th>
                                        <th>Avg per Transaction</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for loc in location_performance %}
                                    <tr>
                                        <td><strong>{{ loc.location }}</strong></td>
                                        <td>{{ loc.total_units }}</td>
                                        <td>₦{{ loc.total_revenue|floatformat:2 }}</td>
                                        <td>₦{{ loc.avg_per_transaction|floatformat:2 }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="4" class="text-center text-muted">No location data available</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Category Statistics -->
            <div class="col-lg-6">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Category Statistics</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered table-sm">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>Products</th>
                                        <th>Stock Qty</th>
                                        <th>Total Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for cat in category_stats %}
                                    <tr>
                                        <td><strong>{{ cat.category }}</strong></td>
                                        <td>{{ cat.product_count }}</td>
                                        <td>{{ cat.total_quantity }}</td>
                                        <td>₦{{ cat.total_value|floatformat:2 }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="4" class="text-center text-muted">No category data available</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Low Stock Alert -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow mb-4">
                    <div class="card-header py-3 d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-primary">Low Stock Alert</h6>
                        <a href="{% url 'oem_reporting:stock_alerts' %}" class="btn btn-sm btn-outline-primary">View All Alerts</a>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Category</th>
                                        <th>Location</th>
                                        <th>Current Stock</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for alert in low_stock_alerts %}
                                    <tr>
                                        <td>{{ alert.brand }}</td>
                                        <td>{{ alert.category }}</td>
                                        <td>{{ alert.location }}</td>
                                        <td>{{ alert.quantity_available }}</td>
                                        <td>
                                            {% if alert.quantity_available < 5 %}
                                            <span class="badge bg-danger">Critical</span>
                                            {% else %}
                                            <span class="badge bg-warning text-dark">Low</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">All products are well-stocked</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Revenue Chart
        const revenueCtx = document.getElementById("revenueChart");

        const monthlyLabels = {{ monthly_labels|safe|default:"[]" }};
        const monthlyRevenue = {{ monthly_revenue|safe|default:"[]" }};

        new Chart(revenueCtx, {
            type: 'line',
            data: {
                labels: monthlyLabels,
                datasets: [{
                    label: 'Revenue',
                    data: monthlyRevenue,
                    backgroundColor: 'rgba(78, 115, 223, 0.05)',
                    borderColor: 'rgba(78, 115, 223, 1)',
                    tension: 0.3,
                    fill: true,
                    pointRadius: 4,
                    pointBackgroundColor: 'rgba(78, 115, 223, 1)',
                    pointBorderColor: '#fff',
                    pointHoverRadius: 5
                }]
            },
            options: {
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: value => '₦' + value.toLocaleString()
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: context => `Revenue: ₦${Number(context.parsed.y).toLocaleString()}`
                        }
                    }
                }
            }
        });

        // Category Chart
        const categoryCtx = document.getElementById("categoryChart");

        const categoryLabels = {{ category_labels|safe|default:"[]" }};
        const categoryData = {{ category_data|safe|default:"[]" }};

        new Chart(categoryCtx, {
            type: 'doughnut',
            data: {
                labels: categoryLabels,
                datasets: [{
                    data: categoryData,
                    backgroundColor: [
                        '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e',
                        '#e74a3b', '#858796', '#5a5c69'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: context => {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                return `${label}: ₦${value.toLocaleString()}`;
                            }
                        }
                    }
                }
            }
        });

        // Show/hide custom date inputs
        const filterSelect = document.getElementById('filterSelect');
        const customDateInputs = document.getElementById('customDateInputs');
        filterSelect.addEventListener('change', function () {
            customDateInputs.style.display = this.value === 'custom' ? 'flex' : 'none';
        });
    </script>
</body>
</html>
