<!-- receipt_detail.html -->
{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
    /* === PRINT SETTINGS: Force Maximum Darkness & Boldness === */
    @media print {
        @page {
            size: 80mm auto;
            margin: 0;
        }

        body, html {
            width: 80mm;
            margin: 0;
            padding: 0;
            background: #fff !important;
            color: #000 !important;
        }

        /* üî• FORCE EVERY ELEMENT TO BE BOLD AND BLACK */
        *,
        *::before,
        *::after {
            color: #000 !important;
            background: transparent !important;
            text-shadow: none !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
            font-weight: 900 !important; /* MAXIMUM BOLD */
            font-size: 11px !important; /* Slightly larger for readability */
        }

        /* Ensure no element overrides boldness */
        body * {
            font-weight: 900 !important;
        }

        /* Hide non-receipt elements */
        nav, footer, .no-print, button, a {
            display: none !important;
        }

        .receipt-container {
            padding: 0 !important;
            margin: 0 !important;
            border: none !important;
            box-shadow: none !important;
        }

        /* Force all borders to be solid black */
        .divider,
        th,
        td,
        .payment-summary .fw-bold {
            border-color: #000 !important;
        }
    }

    /* === GENERAL RECEIPT STYLING (Screen & Print) === */
    .receipt-container {
        width: 80mm;
        max-width: 100%;
        margin: 10px auto;
        padding: 5px 5px 25px;
        font-family: 'Courier New', monospace;
        font-size: 11.5px;
        line-height: 1.3;
        background: #fff;
        color: #000;
        box-sizing: border-box;
        border: 1px solid #ddd;
    }

    /* üî• Make all text EXTRA BOLD by default */
    .receipt-container * {
        font-weight: 900; /* Maximum bold */
        color: #000;
    }

    /* === COMPANY INFO === */
    .company-info {
        text-align: center;
        margin-bottom: 6px;
    }

    .company-info img {
        width: 75px;
        height: auto;
        margin: 2px auto 4px;
        border: 2px solid #000; /* Thicker border */
        border-radius: 4px;
        padding: 1px;
    }

    .company-info h2 {
        margin: 3px 0;
        font-size: 14px;
        font-weight: 900;
        letter-spacing: 0.8px;
        text-transform: uppercase;
    }

    .company-info p {
        margin: 2px 0;
        font-size: 10.5px;
        color: #000;
    }

    /* === RECEIPT HEADER === */
    .receipt-header {
        text-align: center;
        margin: 6px 0;
        padding-bottom: 4px;
        border-bottom: 2px dashed #000;
    }

    .receipt-header h2 {
        margin: 2px 0;
        font-size: 13px;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .receipt-header p {
        margin: 2px 0;
        font-size: 10.5px;
    }

    /* === SECTION TITLES === */
    h4 {
        text-align: center;
        font-size: 12px;
        font-weight: 900;
        margin: 8px 0 4px;
        letter-spacing: 1px;
        border-bottom: 1px solid #000;
        padding-bottom: 2px;
    }

    /* === ITEMS TABLE === */
    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 11px;
        margin: 5px 0;
        font-weight: 900;
    }

    th {
        font-weight: 900;
        text-align: center;
        padding: 4px 2px;
        border-top: 2px solid #000;
        border-bottom: 2px solid #000;
        background: #000;
        color: #fff !important;
        font-size: 11px;
    }

    td {
        padding: 3px 2px;
        border-bottom: 1px solid #000;
        color: #000;
    }

    .item-name {
        width: 50%;
        word-wrap: break-word;
        text-align: left;
        padding-left: 3px;
    }

    .qty {
        width: 15%;
        text-align: center;
    }

    .price {
        width: 20%;
        text-align: right;
        padding-right: 3px;
    }

    .total {
        width: 25%;
        text-align: right;
        padding-right: 3px;
        font-weight: 900;
    }

    /* === DIVIDER === */
    .divider {
        border-top: 2px dashed #000;
        margin: 8px 0 6px 0;
    }

    /* === PAYMENT SUMMARY === */
    .payment-summary {
        font-size: 11px;
        line-height: 1.5;
        margin-top: 5px;
    }

    .payment-summary p {
        margin: 3px 0;
        display: flex;
        justify-content: space-between;
        font-weight: 900;
    }

    .payment-summary .fw-bold {
        font-weight: 900 !important;
        border-top: 2px solid #000;
        padding-top: 4px;
        margin-top: 5px;
        font-size: 12px;
    }

    /* === DISCOUNT SUMMARY === */
    .discount-summary {
        font-size: 10.5px;
        margin: 5px 0;
        color: #000;
    }

    .discount-summary p {
        margin: 2px 0;
        display: flex;
        justify-content: space-between;
        font-weight: 900;
    }

    /* === FOOTER === */
    .footer {
        text-align: center;
        margin-top: 10px;
        font-size: 10px;
        font-style: italic;
        color: #000;
        font-weight: 900;
    }

    /* === ACTION BUTTONS === */
    #printButton {
        width: 100%;
        padding: 12px;
        margin-top: 20px;
        font-size: 16px;
        font-weight: 900;
        background-color: #d9003f;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.2s;
    }

    #printButton:hover {
        background-color: #ff1a4f;
    }

    .back-button {
        display: block;
        width: 100%;
        padding: 12px;
        margin-top: 10px;
        font-size: 14px;
        font-weight: 900;
        background-color: #6c757d;
        color: white;
        border: none;
        border-radius: 6px;
        text-align: center;
        text-decoration: none;
        cursor: pointer;
        transition: background 0.2s;
    }

    .back-button:hover {
        background-color: #5a6268;
        color: white;
    }

    /* === DARK MODE OVERRIDE === */
    @media (prefers-color-scheme: dark) {
        .receipt-container {
            background: #000;
            color: #fff;
        }
        .company-info, .footer, .payment-summary {
            color: #fff;
        }
        @media print {
            .receipt-container {
                background: #fff !important;
                color: #000 !important;
            }
            .receipt-container * {
                color: #000 !important;
                background: transparent !important;
            }
        }
    }
</style>

<div class="receipt-container">
    <!-- Company Info -->
    <div class="company-info">
        {% if store_config.receipt_logo %}
        <img src="{{ store_config.receipt_logo.url }}" alt="{{ store_name }} Logo">
        {% elif store_config.logo %}
        <img src="{{ store_config.logo.url }}" alt="{{ store_name }} Logo">
        {% else %}
        <img src="{% static 'img/Wlogo.png' %}" alt="{{ store_name }} Logo">
        {% endif %}
        <h2>{{ store_name }}</h2>
        <p>{{ store_config.address_line_1 }}</p>
        {% if store_config.address_line_2 %}<p>{{ store_config.address_line_2 }}</p>{% endif %}
        <p>{{ store_phone }}</p>
        <p>{{ store_email }}</p>
        {% if store_config.receipt_header_text %}
        <p style="margin-top: 8px; font-style: italic;">{{ store_config.receipt_header_text }}</p>
        {% endif %}
    </div>

    <!-- Receipt Header -->
    <div class="receipt-header">
        {% if receipt.payment_status == 'partial' %}
        <h2 style="color: #ff6b00; font-weight: 900; border: 3px solid #ff6b00; padding: 8px; background: #fff3e0;">*** DEPOSIT RECEIPT ***</h2>
        {% else %}
        <h2>Sales Receipt</h2>
        {% endif %}
        <p><strong>No:</strong> {{ receipt.receipt_number }}</p>
        <p><strong>Date:</strong> {{ receipt.date|date:"D d M Y H:i" }}</p>
        <p><strong>Cashier:</strong> {{ user.username|truncatechars:15 }}</p>
        {% if customer_name != "No customer" %}
            <p><strong>Customer:</strong> {{ customer_name|truncatechars:18 }}</p>
        {% endif %}
        {% if receipt.payment_status == 'partial' %}
            <p style="margin-top: 6px; padding: 4px; background: #fff3e0; border: 2px solid #ff6b00;">
                <strong>Status:</strong> <span style="color: #ff6b00; font-weight: 900;">PARTIAL PAYMENT</span>
            </p>
        {% elif receipt.payment_status == 'paid' and payment_history.count > 1 %}
            <p style="margin-top: 6px; padding: 4px; background: #e8f5e9; border: 2px solid #28a745;">
                <strong>Status:</strong> <span style="color: #28a745; font-weight: 900;">FULLY PAID</span>
            </p>
        {% endif %}
    </div>

    <!-- Items Table -->
    <h4>Items Purchased</h4>
    <table>
        <thead>
            <tr>
                <th class="item-name">Item</th>
                <th class="qty">Qty</th>
                <th class="price">Price ({{ currency_symbol }})</th>
                <th class="total">Total ({{ currency_symbol }})</th>
            </tr>
        </thead>
        <tbody>
            {% for sale in sales %}
            <tr>
                <td class="item-name">{{ sale.product.brand|truncatechars:20 }}</td>
                <td class="qty">{{ sale.quantity }}</td>
                <td class="price">{{ sale.product.selling_price|floatformat:2 }}</td>
                <td class="total">{{ sale.total_price|floatformat:2 }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="divider"></div>

    <!-- Discount Summary (if any discounts exist) -->
    {% if total_item_discount > 0 or total_bill_discount > 0 %}
    <div class="discount-summary">
        <h4>Discounts Applied</h4>
        {% if total_item_discount > 0 %}
            {% for sale in sales %}
                {% if sale.discount_amount > 0 %}
                <p>
                    <span>{{ sale.product.brand|truncatechars:15 }}:</span>
                    <span>-{{ currency_symbol }}{{ sale.discount_amount|floatformat:2 }}</span>
                </p>
                {% endif %}
            {% endfor %}
        {% endif %}

        {% if total_bill_discount > 0 %}
            <p>
                <span>Bill Discount ({{ payment.discount_percentage|default:0 }}%):</span>
                <span>-{{ currency_symbol }}{{ total_bill_discount|floatformat:2 }}</span>
            </p>
        {% endif %}
    </div>
    <div class="divider"></div>
    {% endif %}

    <!-- Payment Summary -->
    <div class="payment-summary">
        {% if total_item_discount > 0 or total_bill_discount > 0 or receipt.loyalty_discount_amount > 0 %}
            <p><span>Subtotal (before discounts):</span> <span>{{ currency_symbol }}{{ total_price_before_discount|floatformat:2 }}</span></p>
        {% endif %}

        {% if total_item_discount > 0 %}
            <p><span>Item Discounts:</span> <span>-{{ currency_symbol }}{{ total_item_discount|floatformat:2 }}</span></p>
        {% endif %}

        {% if total_bill_discount > 0 %}
            <p><span>Bill Discount:</span> <span>-{{ currency_symbol }}{{ total_bill_discount|floatformat:2 }}</span></p>
        {% endif %}

        {% if receipt.loyalty_discount_amount > 0 %}
            <p style="color: #28a745; font-weight: 700; font-size: 1.05em; background-color: #d4edda; padding: 8px; border-radius: 5px; margin: 10px 0;">
                <span>üíö Loyalty Discount ({{ receipt.loyalty_points_redeemed }} points redeemed):</span>
                <span>-{{ currency_symbol }}{{ receipt.loyalty_discount_amount|floatformat:2 }}</span>
            </p>
        {% endif %}

        {% if delivery_cost > 0 %}
            <p><span>Delivery:</span> <span>+{{ currency_symbol }}{{ delivery_cost|floatformat:2 }}</span></p>
        {% endif %}

        <!-- Tax Breakdown -->
        {% if receipt.tax_amount > 0 and receipt.tax_details %}
            <h4 class="mt-3">Tax Breakdown</h4>
            {% load custom_filters %}
            {% with tax_data=receipt.tax_details|parse_json %}
                {% for tax_code, tax_info in tax_data.items %}
                    <p class="small">
                        <span>{{ tax_info.name }} ({{ tax_info.rate }}%
                        {% if tax_info.method == 'inclusive' %}
                            <i class="bi bi-arrow-down-circle text-success" title="Inclusive"></i>
                        {% else %}
                            <i class="bi bi-arrow-up-circle text-warning" title="Exclusive"></i>
                        {% endif %}):</span>
                        <span>{{ currency_symbol }}{{ tax_info.amount|floatformat:2 }}</span>
                    </p>
                {% endfor %}
            {% endwith %}
            <p><span>Total Tax:</span> <span>{{ currency_symbol }}{{ receipt.tax_amount|floatformat:2 }}</span></p>
        {% endif %}

        <p class="fw-bold"><span>Grand Total:</span> <span>{{ currency_symbol }}{{ final_total|floatformat:2 }}</span></p>

        <!-- Payment Methods -->
        {% if payment_methods %}
            <h4>Payment Methods</h4>
            {% for method in payment_methods %}
                <p>
                    <span>{{ method.get_payment_method_display }}:</span>
                    <span>{{ currency_symbol }}{{ method.amount|floatformat:2 }}</span>
                </p>
            {% endfor %}
        {% endif %}

        <p><span>Total Paid:</span> <span>{{ currency_symbol }}{{ total_paid|floatformat:2 }}</span></p>

        {% if change_amount > 0 %}
            <p><span>Change:</span> <span>{{ currency_symbol }}{{ change_amount|floatformat:2 }}</span></p>
        {% endif %}

        <!-- Deposit/Balance Breakdown for Partial Payments -->
        {% if receipt.payment_status == 'partial' or payment_history.count > 0 %}
        <div class="divider" style="margin: 12px 0;"></div>
        <h4 style="background: #f0f0f0; padding: 6px; border: 2px solid #000;">PAYMENT BREAKDOWN</h4>

        {% if receipt.payment_status == 'partial' %}
            <p style="color: #ff6b00; font-weight: 900; background: #fff3e0; padding: 4px; border: 2px solid #ff6b00; font-size: 12px;">
                <span>üí∞ DEPOSIT PAID:</span>
                <span>{{ currency_symbol }}{{ receipt.amount_paid|floatformat:2 }}</span>
            </p>
            <p style="color: #dc3545; font-weight: 900; background: #f8d7da; padding: 4px; border: 2px solid #dc3545; font-size: 13px;">
                <span>‚ö†Ô∏è BALANCE DUE:</span>
                <span>{{ currency_symbol }}{{ receipt.balance_remaining|floatformat:2 }}</span>
            </p>
        {% elif receipt.payment_status == 'paid' and payment_history.count > 1 %}
            {% with first_payment=payment_history|last last_payment=payment_history|first %}
            <p style="color: #ff6b00; font-weight: 900; background: #fff3e0; padding: 4px; border: 1px solid #ff6b00; font-size: 11px;">
                <span>üí∞ DEPOSIT ({{ first_payment.payment_date|date:"d/m/Y" }}):</span>
                <span>{{ currency_symbol }}{{ first_payment.amount|floatformat:2 }}</span>
            </p>
            <p style="color: #28a745; font-weight: 900; background: #e8f5e9; padding: 4px; border: 1px solid #28a745; font-size: 11px;">
                <span>‚úÖ BALANCE ({{ last_payment.payment_date|date:"d/m/Y" }}):</span>
                <span>{{ currency_symbol }}{{ last_payment.amount|floatformat:2 }}</span>
            </p>
            <p style="color: #000; font-weight: 900; background: #f0f0f0; padding: 6px; border: 2px solid #000; font-size: 12px; margin-top: 4px;">
                <span>TOTAL PAID:</span>
                <span>{{ currency_symbol }}{{ receipt.amount_paid|floatformat:2 }}</span>
            </p>
            {% endwith %}
        {% endif %}

        {% if payment_history %}
        <div class="divider" style="margin: 8px 0;"></div>
        <h4>Payment History</h4>
        <table style="font-size: 10px; margin: 4px 0;">
            <thead>
                <tr style="background: #f0f0f0;">
                    <th style="text-align: left; padding: 3px;">Type</th>
                    <th style="text-align: left; padding: 3px;">Date</th>
                    <th style="text-align: left; padding: 3px;">Method</th>
                    <th style="text-align: right; padding: 3px;">Amount</th>
                </tr>
            </thead>
            <tbody>
                {% for payment in payment_history %}
                <tr style="border-bottom: 1px solid #ddd;">
                    <td style="padding: 3px; font-size: 9px; font-weight: 900;">
                        {% if forloop.first and payment_history.count > 1 %}
                            <span style="color: #ff6b00;">DEPOSIT</span>
                        {% elif forloop.last and payment_history.count > 1 and receipt.payment_status == 'paid' %}
                            <span style="color: #28a745;">BALANCE</span>
                        {% elif payment_history.count == 1 and receipt.payment_status == 'partial' %}
                            <span style="color: #ff6b00;">DEPOSIT</span>
                        {% else %}
                            <span style="color: #28a745;">PAYMENT {{ forloop.counter }}</span>
                        {% endif %}
                    </td>
                    <td style="padding: 3px; font-size: 9px;">{{ payment.payment_date|date:"d/m/Y" }}</td>
                    <td style="padding: 3px; font-size: 9px;">{{ payment.payment_method }}</td>
                    <td style="text-align: right; padding: 3px; font-weight: 900;">{{ currency_symbol }}{{ payment.amount|floatformat:2 }}</td>
                </tr>
                {% if payment.notes %}
                <tr>
                    <td colspan="4" style="font-size: 8px; font-style: italic; padding: 2px; background: #f9f9f9; border-bottom: 1px solid #ddd;">
                        Note: {{ payment.notes }}
                    </td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
            <tfoot style="background: #f0f0f0; border-top: 2px solid #000;">
                <tr>
                    <th colspan="3" style="padding: 4px; font-weight: 900; font-size: 11px;">TOTAL PAID:</th>
                    <th style="text-align: right; padding: 4px; font-weight: 900; color: #28a745; font-size: 11px;">{{ currency_symbol }}{{ receipt.amount_paid|floatformat:2 }}</th>
                </tr>
            </tfoot>
        </table>
        {% endif %}
        {% endif %}
    </div>

    <!-- Loyalty Points Section -->
    {% if loyalty_info %}
    <div class="divider"></div>
    <div class="payment-summary">
        <h4>üéâ {{ loyalty_info.program_name }}</h4>
        <p><span>Points Earned:</span> <span>+{{ loyalty_info.points_earned }} pts</span></p>
        <p><span>Previous Balance:</span> <span>{{ loyalty_info.previous_balance }} pts</span></p>
        <p class="fw-bold"><span>New Balance:</span> <span>{{ loyalty_info.new_balance }} pts</span></p>
        <p style="color: #28a745;"><span>üí∞ Redeemable Value:</span> <span>{{ currency_symbol }}{{ loyalty_info.redeemable_value|floatformat:2 }}</span></p>
    </div>
    {% endif %}

    <!-- Delivery Info -->
    {% if delivery %}
    <div class="divider"></div>
    <div class="payment-summary">
        <h4>üöö Delivery Information</h4>
        <p><span>Option:</span> <span>{% if delivery.delivery_option == 'pickup' %}Customer Pickup{% else %}Home Delivery{% endif %}</span></p>
        {% if delivery.delivery_address %}
        <p style="font-size: 10px; word-wrap: break-word;"><span>Address:</span> <span>{{ delivery.delivery_address }}</span></p>
        {% endif %}
        {% if delivery.delivery_date %}
        <p><span>Date:</span> <span>{{ delivery.delivery_date|date:"d M Y" }}</span></p>
        {% endif %}
    </div>
    {% endif %}

    <!-- Footer -->
    <div class="footer">
        <div class="divider"></div>
        {% if store_config.receipt_footer_text %}
        <p>{{ store_config.receipt_footer_text|linebreaks }}</p>
        {% else %}
        <p>Thank you for shopping with us!</p>
        <p>We value your patronage.</p>
        {% endif %}
    </div>

    <!-- Action Buttons -->
    <button id="printButton" onclick="window.print()" class="no-print">
        üñ®Ô∏è Print Receipt
    </button>
    <a href="{% url 'return_select_receipt' receipt.id %}" class="back-button no-print" style="background: #dc3545; margin-top: 5px;">
        ‚Ü©Ô∏è Process Return
    </a>
    <a href="{% url 'receipt_list' %}" class="back-button no-print">
        ‚Üê Back to Receipts
    </a>
</div>
{% endblock %}

{% block extra_js %}
<!-- Optional: Auto-print after load (uncomment if needed) -->
<!--
<script>
    window.addEventListener("load", () => {
        setTimeout(() => window.print(), 500);
    });
</script>
-->
{% endblock %}