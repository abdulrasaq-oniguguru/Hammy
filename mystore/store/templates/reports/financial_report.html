{% extends 'base.html' %}
{% load static %}
{% block title %}Financial Report{% endblock %}
{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Left Sidebar: Filters -->
        <div class="col-lg-2 col-md-3 col-sm-4 mb-4">
            <div class="card shadow-sm" style="background: #2c2c2d; border: none; border-radius: 12px;">
                <div class="card-header" style="background: #1f1f1f; color: #e0e0e0; border-bottom: 1px solid #444;">
                    <h6 class="mb-0">Filters</h6>
                </div>
                <div class="card-body p-3" style="color: #e0e0e0;">
                    <form method="get" class="small">
                        <!-- Start Date -->
                        <div class="form-group mb-3">
                            <label for="start_date" class="form-label text-white-50">Start Date</label>
                            <input type="date" name="start_date" class="form-control form-control-sm bg-dark text-white border-secondary"
                                   value="{{ start_date|date:'Y-m-d' }}">
                        </div>
                        <!-- End Date -->
                        <div class="form-group mb-3">
                            <label for="end_date" class="form-label text-white-50">End Date</label>
                            <input type="date" name="end_date" class="form-control form-control-sm bg-dark text-white border-secondary"
                                   value="{{ end_date|date:'Y-m-d' }}">
                        </div>
                        <!-- Report Type -->
                        <div class="form-group mb-3">
                            <label for="report_type" class="form-label text-white-50">Focus</label>
                            <select name="report_type" class="form-select form-select-sm bg-dark text-white border-secondary">
                                <option value="revenue" {% if report_type == 'revenue' %}selected{% endif %}>Revenue Analysis</option>
                                <option value="payments" {% if report_type == 'payments' %}selected{% endif %}>Payment Methods</option>
                                <option value="discounts" {% if report_type == 'discounts' %}selected{% endif %}>Discounts & Fees</option>
                            </select>
                        </div>
                        <!-- Actions -->
                        <button type="submit" class="btn btn-primary btn-sm w-100 mb-2">Apply</button>
                        <a href="{% url 'financial_report' %}" class="btn btn-outline-secondary btn-sm w-100">Clear</a>
                    </form>
                </div>
            </div>
            <!-- Export Buttons -->
            <div class="mt-3">
                <div class="btn-group w-100" role="group">
                    <button class="btn btn-success btn-sm flex-grow-1" onclick="exportToExcel()">
                        <i class="fas fa-file-excel"></i> Export Excel
                    </button>
                    <button class="btn btn-danger btn-sm flex-grow-1" onclick="exportToPDF()">
                        <i class="fas fa-file-pdf"></i> Export PDF
                    </button>
                </div>
            </div>
        </div>
        <!-- Main Content Area -->
        <div class="col-lg-10 col-md-9 col-sm-8">
            <!-- Page Title -->
            <h1 class="h3 mb-4 text-white">
                <i class="fas fa-chart-line"></i> Financial Report
                <span class="badge bg-primary ms-2">{{ total_transactions }} Transactions</span>
            </h1>
            <!-- Revenue Overview Cards -->
            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="card shadow-sm" style="background: #2c2c2d; border-left: 4px solid #4e73df; color: #e0e0e0;">
                        <div class="card-body">
                            <h6 class="card-title text-primary">Gross Revenue</h6>
                            <p class="card-text fs-5 mb-1">{{ currency_symbol }}{{ gross_revenue|floatformat:2 }}</p>
                            <small class="text-muted">Before discounts</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card shadow-sm" style="background: #2c2c2d; border-left: 4px solid #1cc88a; color: #e0e0e0;">
                        <div class="card-body">
                            <h6 class="card-title text-success">Net Revenue</h6>
                            <p class="card-text fs-5 mb-1">{{ currency_symbol }}{{ net_revenue|floatformat:2 }}</p>
                            <small class="text-muted">After discounts, ex. delivery</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card shadow-sm" style="background: #2c2c2d; border-left: 4px solid #f6c23e; color: #e0e0e0;">
                        <div class="card-body">
                            <h6 class="card-title text-warning">Total Profit</h6>
                            <p class="card-text fs-5 mb-1">{{ currency_symbol }}{{ total_profit|floatformat:2 }}</p>
                            <small class="text-muted">{{ profit_margin|floatformat:1 }}% margin</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card shadow-sm" style="background: #2c2c2d; border-left: 4px solid #36b9cc; color: #e0e0e0;">
                        <div class="card-body">
                            <h6 class="card-title text-info">Avg Transaction</h6>
                            <p class="card-text fs-5 mb-1">{{ currency_symbol }}{{ avg_transaction_value|floatformat:2 }}</p>
                            <small class="text-muted">Per transaction</small>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Payment Method Breakdown - Main Focus -->
            <div class="card shadow-sm mb-4" style="background: #2c2c2d; border: none; border-radius: 12px;">
                <div class="card-header d-flex justify-content-between align-items-center" style="background: #1f1f1f; border-bottom: 1px solid #444;">
                    <h6 class="mb-0 text-white">
                        <i class="fas fa-credit-card"></i> Payment Method Breakdown
                    </h6>
                    <span class="badge bg-success">Most Important</span>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for method, data in payment_method_breakdown.items %}
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="card bg-dark border-secondary">
                                <div class="card-body text-center">
                                    <h6 class="card-title text-white">{{ method }}</h6>
                                    <h4 class="text-success mb-2">{{ currency_symbol }}{{ data.total_amount|floatformat:2 }}</h4>
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <small class="text-muted">Transactions</small>
                                            <div class="text-white fw-bold">{{ data.transaction_count }}</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Average</small>
                                            <div class="text-white fw-bold">{{ currency_symbol }}{{ data.avg_transaction|floatformat:2 }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12">
                            <p class="text-muted text-center">No payment data available</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <!-- Discount & Fees Analysis -->
            <div class="row mb-4">
                <!-- Discount Breakdown -->
                <div class="col-md-8">
                    <div class="card shadow-sm" style="background: #2c2c2d; border: none; border-radius: 12px;">
                        <div class="card-header" style="background: #1f1f1f; border-bottom: 1px solid #444;">
                            <h6 class="mb-0 text-white">
                                <i class="fas fa-percentage"></i> Discount Analysis
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 text-center">
                                    <div class="mb-3">
                                        <h6 class="text-warning">Item-Level Discounts</h6>
                                        <h4 class="text-white">{{ currency_symbol }}{{ discount_breakdown.item_level_discounts|floatformat:2 }}</h4>
                                        <small class="text-muted">Applied to individual items</small>
                                    </div>
                                </div>
                                <div class="col-md-4 text-center">
                                    <div class="mb-3">
                                        <h6 class="text-info">Payment-Level Discounts</h6>
                                        <h4 class="text-white">{{ currency_symbol }}{{ discount_breakdown.payment_level_discounts|floatformat:2 }}</h4>
                                        <small class="text-muted">Applied to total payment</small>
                                    </div>
                                </div>
                                <div class="col-md-4 text-center">
                                    <div class="mb-3">
                                        <h6 class="text-danger">Total Discounts</h6>
                                        <h4 class="text-white">{{ currency_symbol }}{{ discount_breakdown.total_discounts|floatformat:2 }}</h4>
                                        <small class="text-muted">{{ discount_breakdown.discount_rate|floatformat:1 }}% of gross revenue</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Delivery Fees -->
                <div class="col-md-4">
                    <div class="card shadow-sm" style="background: #2c2c2d; border: none; border-radius: 12px;">
                        <div class="card-header" style="background: #1f1f1f; border-bottom: 1px solid #444;">
                            <h6 class="mb-0 text-white">
                                <i class="fas fa-truck"></i> Delivery Fees
                            </h6>
                        </div>
                        <div class="card-body text-center">
                            <h4 class="text-success mb-2">{{ currency_symbol }}{{ total_delivery_fees|floatformat:2 }}</h4>
                            <p class="text-muted mb-1">Total delivery fees collected</p>
                            <small class="text-white-50">Additional revenue stream</small>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Payment Status Overview -->
            <div class="card shadow-sm mb-4" style="background: #2c2c2d; border: none; border-radius: 12px;">
                <div class="card-header" style="background: #1f1f1f; border-bottom: 1px solid #444;">
                    <h6 class="mb-0 text-white">
                        <i class="fas fa-chart-pie"></i> Payment Status Overview
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 text-center">
                            <div class="mb-3">
                                <h6 class="text-success">Completed</h6>
                                <h4 class="text-white">{{ payment_status_breakdown.completed }}</h4>
                                <p class="text-success mb-0">{{ currency_symbol }}{{ completed_amount|floatformat:2 }}</p>
                                <small class="text-muted">Full payments received</small>
                            </div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="mb-3">
                                <h6 class="text-warning">Partial</h6>
                                <h4 class="text-white">{{ payment_status_breakdown.partial }}</h4>
                                <p class="text-warning mb-0">{{ currency_symbol }}{{ partial_amount|floatformat:2 }}</p>
                                <small class="text-muted">Partially paid orders</small>
                            </div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="mb-3">
                                <h6 class="text-secondary">Pending</h6>
                                <h4 class="text-white">{{ payment_status_breakdown.pending }}</h4>
                                <p class="text-secondary mb-0">{{ currency_symbol }}{{ pending_amount|floatformat:2 }}</p>
                                <small class="text-muted">Awaiting payment</small>
                            </div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="mb-3">
                                <h6 class="text-danger">Failed</h6>
                                <h4 class="text-white">{{ payment_status_breakdown.failed }}</h4>
                                <p class="text-danger mb-0">{{ currency_symbol }}0.00</p>
                                <small class="text-muted">Failed transactions</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Monthly Trend Chart -->
            <div class="card shadow-sm" style="background: #2c2c2d; border: none; border-radius: 12px;">
                <div class="card-header" style="background: #1f1f1f; border-bottom: 1px solid #444;">
                    <h6 class="mb-0 text-white">
                        <i class="fas fa-chart-area"></i> Monthly Financial Trends
                    </h6>
                </div>
                <div class="card-body">
                    <!-- FIXED: Chart Container -->
                    <div style="height: 300px; position: relative; margin-bottom: 1.5rem;">
                        <canvas id="financialTrendChart"></canvas>
                    </div>

                    <!-- Monthly Details Table -->
                    <div class="table-responsive mt-4">
                        <table class="table table-dark table-striped table-sm">
                            <thead>
                                <tr>
                                    <th>Month</th>
                                    <th>Revenue</th>
                                    <th>Discounts</th>
                                    <th>Delivery Fees</th>
                                    <th>Net Revenue</th>
                                    <th>Transactions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for month in monthly_data %}
                                <tr>
                                    <td>{{ month.month|date:"M Y" }}</td>
                                    <td>{{ currency_symbol }}{{ month.revenue|floatformat:2 }}</td>
                                    <td class="text-warning">{{ currency_symbol }}{{ month.discount_amount|floatformat:2 }}</td>
                                    <td class="text-success">{{ currency_symbol }}{{ month.delivery_fees|floatformat:2 }}</td>
                                    <td class="text-info">{{ currency_symbol }}{{ month.net_revenue|floatformat:2 }}</td>
                                    <td>{{ month.transaction_count }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">No monthly data available</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Chart.js -->
<script src="{% static 'js/chart.umd.min.js' %}"></script>
<!-- Export Functions -->
<script>
function exportToExcel() {
    // Create Excel export with payment method breakdown focus
    const data = [
        ['Financial Report - Payment Analysis'],
        [''],
        ['Payment Method Breakdown'],
        ['Method', 'Total Amount', 'Transactions', 'Average Amount'],
        {% for method, data in payment_method_breakdown.items %}
        ['{{ method }}', {{ data.total_amount }}, {{ data.transaction_count }}, {{ data.avg_transaction }}],
        {% endfor %}
        [''],
        ['Discount Analysis'],
        ['Type', 'Amount'],
        ['Item-Level Discounts', {{ discount_breakdown.item_level_discounts }}],
        ['Payment-Level Discounts', {{ discount_breakdown.payment_level_discounts }}],
        ['Total Discounts', {{ discount_breakdown.total_discounts }}],
        [''],
        ['Revenue Summary'],
        ['Metric', 'Amount'],
        ['Gross Revenue', {{ gross_revenue }}],
        ['Net Revenue', {{ net_revenue }}],
        ['Total Profit', {{ total_profit }}],
        ['Delivery Fees', {{ total_delivery_fees }}],
        [''],
        ['Payment Status'],
        ['Status', 'Count', 'Amount'],
        ['Completed', {{ payment_status_breakdown.completed }}, {{ completed_amount }}],
        ['Partial', {{ payment_status_breakdown.partial }}, {{ partial_amount }}],
        ['Pending', {{ payment_status_breakdown.pending }}, {{ pending_amount }}],
        ['Failed', {{ payment_status_breakdown.failed }}, 0]
    ];
    let csvContent = '';
    data.forEach(row => {
        csvContent += row.join(',') + '\n';
    });
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'financial_report_' + new Date().toISOString().slice(0, 10) + '.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}

function exportToPDF() {
    // Get current filter values
    const url = new URL(window.location.href);
    url.searchParams.set('export', 'pdf');
    window.location.href = url.toString();
}
</script>
<!-- Chart Script -->
<script>
    const ctx = document.getElementById('financialTrendChart').getContext('2d');
    const financialChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [{% for month in monthly_data %}'{{ month.month|date:"M Y" }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
            datasets: [
                {
                    label: 'Revenue ({{ currency_symbol }})',
                    data: [{% for month in monthly_data %}{{ month.revenue }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                    borderColor: '#4e73df',
                    backgroundColor: 'rgba(78, 115, 223, 0.1)',
                    tension: 0.3,
                    fill: true
                },
                {
                    label: 'Discounts ({{ currency_symbol }})',
                    data: [{% for month in monthly_data %}{{ month.discount_amount }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                    borderColor: '#f6c23e',
                    backgroundColor: 'rgba(246, 194, 62, 0.1)',
                    tension: 0.3,
                    fill: false
                },
                {
                    label: 'Delivery Fees ({{ currency_symbol }})',
                    data: [{% for month in monthly_data %}{{ month.delivery_fees }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                    borderColor: '#1cc88a',
                    backgroundColor: 'rgba(28, 200, 138, 0.1)',
                    tension: 0.3,
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { labels: { color: '#e0e0e0' } },
                tooltip: {
                    backgroundColor: '#343a40',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': {{ currency_symbol }}' + context.parsed.y.toLocaleString();
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: { color: '#e0e0e0' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                y: {
                    ticks: {
                        color: '#e0e0e0',
                        callback: function(value) {
                            return '{{ currency_symbol }}' + value.toLocaleString();
                        }
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    beginAtZero: true
                }
            }
        }
    });
</script>
<!-- Custom Styles -->
<style>
    .form-label, .form-control, .form-select {
        font-size: 0.8rem;
    }
    .table th, .table td {
        padding: 0.5rem;
        font-size: 0.85rem;
    }
    .card {
        border-radius: 12px;
    }
    .bg-dark {
        background-color: #1a1a1a !important;
    }
    .border-secondary {
        border-color: #495057 !important;
    }
    .form-control:focus, .form-select:focus {
        background-color: #1a1a1a !important;
        border-color: #4e73df !important;
        box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
        color: white !important;
    }
    .btn-group .btn {
        border-radius: 0.25rem !important;
    }
    .btn-group .btn:first-child {
        border-top-left-radius: 0.25rem !important;
        border-bottom-left-radius: 0.25rem !important;
    }
    .btn-group .btn:last-child {
        border-top-right-radius: 0.25rem !important;
        border-bottom-right-radius: 0.25rem !important;
    }
</style>
{% endblock %}