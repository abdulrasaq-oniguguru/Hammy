{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="py-5" style="background: linear-gradient(rgba(26, 26, 26, 0.8), rgba(26, 26, 26, 0.8)), url({% static 'img/homepage.jpg' %}) no-repeat center center fixed; background-size: cover;">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="card border-0 shadow" style="background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px);">
                    <div class="card-body p-5 text-center">
                        <!-- Success Icon -->
                        <i class="bi bi-check-circle-fill text-danger display-1 mb-4"></i>

                        <!-- Success Message -->
                        <h2 class="mb-4 fw-bold text-white">Sale Completed Successfully!</h2>
                        <p class="text-muted mb-4">The sale has been processed successfully.</p>

                        {% if receipt %}
                            <p class="mb-4">
                                <strong class="text-white">Receipt Number:</strong>
                                <span class="d-block mt-2 fs-5">#{{ receipt.receipt_number }}</span>
                            </p>

                            <!-- Payment Status & Breakdown -->
                            {% if receipt.payment_status == 'partial' %}
                                <div class="alert alert-warning mb-4" style="background: rgba(255, 193, 7, 0.2); border: 2px solid #ffc107;">
                                    <h5 class="text-warning mb-3"><i class="bi bi-exclamation-triangle-fill"></i> Deposit Receipt</h5>
                                    <div class="row text-start">
                                        <div class="col-6">
                                            <small class="text-muted">Total Amount:</small>
                                            <div class="fs-6 text-white fw-bold">{{ currency_symbol }}{{ receipt.total_with_delivery|floatformat:2 }}</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-success">Deposit Paid:</small>
                                            <div class="fs-6 text-success fw-bold">{{ currency_symbol }}{{ receipt.amount_paid|floatformat:2 }}</div>
                                        </div>
                                    </div>
                                    <div class="row text-start mt-2">
                                        <div class="col-12">
                                            <small class="text-danger">Balance Remaining:</small>
                                            <div class="fs-4 text-danger fw-bold">{{ currency_symbol }}{{ receipt.balance_remaining|floatformat:2 }}</div>
                                        </div>
                                    </div>
                                </div>
                            {% elif receipt.payment_status == 'paid' and payment_history.count > 1 %}
                                <div class="alert alert-success mb-4" style="background: rgba(40, 167, 69, 0.2); border: 2px solid #28a745;">
                                    <h5 class="text-success mb-3"><i class="bi bi-check-circle-fill"></i> Balance Paid in Full</h5>
                                    <div class="row text-start">
                                        <div class="col-6">
                                            <small class="text-muted">Total Amount:</small>
                                            <div class="fs-6 text-white fw-bold">{{ currency_symbol }}{{ receipt.total_with_delivery|floatformat:2 }}</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-success">Total Paid:</small>
                                            <div class="fs-6 text-success fw-bold">{{ currency_symbol }}{{ receipt.amount_paid|floatformat:2 }}</div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}

                            <!-- Payment History -->
                            {% if payment_history %}
                                <div class="card mb-4" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2);">
                                    <div class="card-header" style="background: rgba(255, 255, 255, 0.05); border-bottom: 1px solid rgba(255, 255, 255, 0.2);">
                                        <h6 class="mb-0 text-white"><i class="bi bi-clock-history"></i> Payment History</h6>
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="table-responsive">
                                            <table class="table table-sm mb-0" style="color: rgba(255, 255, 255, 0.9);">
                                                <thead style="background: rgba(255, 255, 255, 0.05);">
                                                    <tr>
                                                        <th class="text-white">Date</th>
                                                        <th class="text-white">Method</th>
                                                        <th class="text-white text-end">Amount</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for payment in payment_history %}
                                                    <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                                                        <td><small>{{ payment.payment_date|date:"M d, Y" }}</small></td>
                                                        <td><span class="badge bg-info">{{ payment.payment_method }}</span></td>
                                                        <td class="text-end"><strong>{{ currency_symbol }}{{ payment.amount|floatformat:2 }}</strong></td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                                <tfoot style="background: rgba(255, 255, 255, 0.05); border-top: 2px solid rgba(255, 255, 255, 0.2);">
                                                    <tr>
                                                        <th colspan="2" class="text-white">Total Paid</th>
                                                        <th class="text-end text-success">{{ currency_symbol }}{{ receipt.amount_paid|floatformat:2 }}</th>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}

                            <!-- View and Print Receipt -->
                            <a href="{% url 'receipt_detail' receipt.id %}" class="btn btn-danger d-flex align-items-center justify-content-center gap-2 mb-3 w-100">
                                <i class="bi bi-receipt"></i> View and Print Receipt
                            </a>

                            <!-- Print to POS Printer -->
                            <button id="posPrintBtn"
                                    onclick="posPrint('{% url 'print_pos_receipt' receipt.id %}')"
                                    class="btn btn-primary d-flex align-items-center justify-content-center gap-2 mb-3 w-100"
                                    style="background-color:#1e40af; border:none; font-weight:bold;">
                                <i class="bi bi-printer-fill"></i> Print to POS Printer
                            </button>
                            <div id="pos-print-status" class="mb-3" style="display:none; font-size:14px; font-weight:600;"></div>

                            <!-- Email Receipt to Customer -->
                            <a href="{% url 'send_receipt_email' receipt.id %}" class="btn btn-outline-light d-flex align-items-center justify-content-center gap-2 mb-3 w-100">
                                <i class="bi bi-envelope-fill"></i> Email Receipt to Customer
                            </a>

                            <!-- Download PDF Receipt -->
                            <a href="{% url 'download_receipt_pdf' receipt.id %}" class="btn btn-outline-light d-flex align-items-center justify-content-center gap-2 mb-3 w-100">
                                <i class="bi bi-file-earmark-pdf"></i> Download PDF Receipt
                            </a>

                            <!-- Go to Receipt List -->
                            <a href="{% url 'receipt_list' %}" class="btn btn-outline-light d-flex align-items-center justify-content-center gap-2 mb-4 w-100">
                                <i class="bi bi-journal-text"></i> Go to Receipt List
                            </a>

                            <a href="{% url 'send_receipt_email' receipt.pk %}" class="btn btn-primary">
                                <i class="bi bi-envelope"></i> Resend Receipt by Email
                            </a>

                        {% else %}
                            <p class="text-muted mb-4">No receipt available for this sale.</p>
                        {% endif %}

                        <!-- Back to Homepage -->
                        <a href="{% url 'homepage' %}" class="btn btn-outline-light d-flex align-items-center justify-content-center gap-2 w-100">
                            <i class="bi bi-house-door"></i> Go Back Home
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .btn-danger {
        background-color: #c8003e;
        border: none;
        font-weight: bold;
        transition: background-color 0.3s ease;
    }

    .btn-danger:hover {
        background-color: #a50034;
    }

    .btn-outline-light:hover {
        background-color: #ffffff22;
        color: white !important;
    }

    i.bi {
        font-size: 1.2rem;
    }

    .w-100 {
        width: 100%;
    }

    .gap-2 {
        gap: 0.75rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
function posPrint(url) {
    const btn    = document.getElementById('posPrintBtn');
    const status = document.getElementById('pos-print-status');
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Printing…';
    status.style.display = 'block';
    status.style.color   = '#aaa';
    status.textContent   = 'Sending to POS printer…';

    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            status.style.color = '#86efac';
            status.textContent = '✅ ' + data.message;
        } else {
            status.style.color = '#fca5a5';
            status.textContent = '❌ ' + data.message;
        }
    })
    .catch(err => {
        status.style.color = '#fca5a5';
        status.textContent = '❌ Network error: ' + err;
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-printer-fill"></i> Print to POS Printer';
    });
}
</script>
{% endblock %}